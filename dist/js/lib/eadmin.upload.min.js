/*!
 eadmin极速后台UI框架（我只想要个后台） | @author:317953536@qq.com 
*/
"use strict";var _createClass=function(){function i(t,e){for(var a=0;a<e.length;a++){var i=e[a];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(t,e,a){return e&&i(t.prototype,e),a&&i(t,a),t}}();function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var Upload=function(){function a(t,e){_classCallCheck(this,a),this.dom=t,this.domCache=scope(this.dom),this.dom+=(new Date).valueOf(),this.domCache.attr("id",this.dom.replace("#","")),this.upload=null,this.pic=[];this.param=$.extend({filename:"file",doc:[".jpg",".gif",".png",".jpeg"],autoupload:!0,maxsize:5e3,maxfile:null,default:"",bind:""},e),null!=this.param.api?(this.param.maxsize/=1e3,!_.startsWith(this.param.api,"http")&&_.startsWith(module.conf.http.baseURL,"http")&&(this.param.api=module.conf.http.baseURL+this.param.api),this.run()):console.log("请指定后端接收上传数据的API地址")}return _createClass(a,[{key:"run",value:function(){this._create(),this._init(),this._event()}},{key:"_create",value:function(){this.domCache.addClass("dropzone").html('<div class="dz-message">\n\t\t\t\t\t<i class="ri-upload-cloud-2-line"></i>\n\t\t\t\t\t将文件拖至此处或点击上传\n\t\t\t\t</div>\n\t\t\t\t<div class="dz-button">\n\t\t\t\t\t<span>待上传：<em></em></span>\n\t\t\t\t\t<button class="highlight small dz-upload-btn">开始上传</button>\n\t\t\t\t</div>'),""!=this.param.bind&&this.domCache.after('<input type="hidden" name="'+this.param.bind+'" value="'+this.param.default+'">')}},{key:"_init",value:function(){var a=this,t={button:this.domCache.children(".dz-button"),uploadTmp:'<div class="dz-preview dz-image-preview">\n\t\t\t\t\t\t\t<div class="dz-image">\n\t\t\t\t\t\t\t\t<img data-dz-thumbnail />\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<div class="dz-details">\n\t\t\t\t\t\t\t\t<div class="dz-filename"><span data-dz-name></span></div>\n\t\t\t\t\t\t\t\t<div class="dz-size" data-dz-size></div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<div class="dz-progress">\n\t\t\t\t\t\t\t\t<span class="dz-upload" data-dz-uploadprogress></span>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<i class="ri-checkbox-circle-fill dz-success-i"></i>\n\t\t\t\t\t\t\t<i class="ri-close-circle-fill dz-error-i"></i>\n\t\t\t\t\t\t\t<i class="ri-close-line dz-remove-i" data-dz-remove></i>\n\t\t\t\t\t\t</div>'};this.upload=new Dropzone(this.dom,{url:this.param.api,paramName:this.param.filename,maxFilesize:this.param.maxsize,acceptedFiles:_.join(this.param.doc,","),autoProcessQueue:this.param.autoupload,parallelUploads:1e3,previewTemplate:t.uploadTmp,maxFiles:this.param.maxfile,dictFileTooBig:"允许上传文件的最大限制为：{{maxFilesize}}MB",dictInvalidFileType:"上传的文件格式不被允许",dictResponseError:"上传文件失败，返回码：{{statusCode}}",dictMaxFilesExceeded:"上传的文件数量超出限制"}),""!=this.param.default&&(t.default=this.param.default.split(","),this.pic=t.default,_.each(t.default,function(t){var e={name:t,accepted:!0};a.upload.emit("addedfile",e),a.upload.emit("thumbnail",e,t),a.upload.emit("success",e),a.upload.emit("complete",e),a.upload.files.push(e)})),Mount.dropzone.push(this.upload)}},{key:"_event",value:function(){var i=this,n={button:i.domCache.find(".dz-button")};i.upload.on("addedfile",function(t){if(-1==t.type.indexOf("image")&&i.domCache.find(".dz-details").show(),!i.param.autoupload){n.button.is(":hidden")&&(i.domCache.css("padding-bottom",40),n.button.show());var e=i.domCache.find(".dz-preview:not(.dz-complete)").length;n.button.find("em").html(e)}}).on("removedfile",function(t){if("error"!=t.status){var e=i.domCache.find(".dz-preview:not(.dz-complete)").length;n.button.find("em").html(e),0==(e=i.domCache.find(".dz-preview").length)&&(i.domCache.css("padding-bottom",10),n.button.hide());var a=void 0;if(null!=t.xhr)a=JSON.parse(t.xhr.response).pic;else a=t.name;if(a=[a],i.pic=_.xor(i.pic,a),""!=i.param.bind)i.domCache.next("input").val(_.split(i.pic,","))}}).on("success",function(t,e){var a=parseInt(n.button.find("em").html());n.button.find("em").html(a-1),i.pic.push(e.pic)}).on("error",function(t,e){i.upload.removeFile(t),Eadmin.message.error({content:e})}).on("queuecomplete",function(){""!=i.param.bind&&i.domCache.next("input").val(_.split(i.pic,","))}),i.param.autoupload||$(i.dom+" .dz-upload-btn").on("click",function(){return i.upload.processQueue(),!1})}}]),a}();