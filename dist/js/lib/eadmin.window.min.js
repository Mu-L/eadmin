/*!
 eadmin极速后台UI框架（我只想要个后台） | @author:317953536@qq.com 
*/
"use strict";var _createClass=function(){function o(t,n){for(var i=0;i<n.length;i++){var o=n[i];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}return function(t,n,i){return n&&o(t.prototype,n),i&&o(t,i),t}}();function _classCallCheck(t,n){if(!(t instanceof n))throw new TypeError("Cannot call a class as a function")}var Window=function(){function o(t,n){_classCallCheck(this,o),this.window="",this.windowDom=null,this.dom=0!=t&&scope(t),this.x=0,this.y=0,this.top=0,this.left=0;var i={url:"",model:"load",width:module.conf.window_width,height:module.conf.window_height,title:module.conf.window_title,drag:!0,btn:[],close:null,submit:null,style:"window"};this.param=$.extend(!0,i,n),this.run()}return _createClass(o,[{key:"run",value:function(){this._event()}},{key:"_create",value:function(){var i={id:createId(),width:0,height:0,style:"",drag:"",html:""};this.window="window-"+i.id,_.isInteger(this.param.width)||-1==this.param.width.indexOf("%")?i.width=this.param.width:i.width=innerW()*(parseInt(this.param.width.replace("%",""))/100),"popup"==this.param.style?i.height=innerH():_.isInteger(this.param.height)||-1==this.param.height.indexOf("%")?i.height=this.param.height:i.height=innerH()*(parseInt(this.param.height.replace("%",""))/100),i.style='style="width:'+i.width+"px;height:"+i.height+"px;","popup"==this.param.style?i.style+='top:0;right:0;left:unset;border-radius:5px 0 0 5px;"':i.style+="margin-left:-"+i.width/2+"px;margin-top:-"+i.height/2+'px;"',this.param.drag&&"window"==this.param.style&&(i.drag=' style="cursor: move;"'),i.height-=60,0<this.param.btn.length&&(i.height-=50),i.html='<div id="'+this.window+'" \n\t\t\t\t\t\tclass="window animated faster'+(null==Mount.window?"":" "+Mount.window)+' dn" '+i.style+'>\n\t\t\t\t\t<div class="window-loading dn">\n\t\t\t\t\t\t<i class="ri-loader-4-line rotate"></i>页面加载中，请稍候...\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="window-close">\n\t\t\t\t\t\t<i class="ri-close-circle-fill"></i>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="title"'+i.drag+'>\n\t\t\t\t\t\t<i class="ri-window-line" style="font-size: 18px;"></i><span>'+this.param.title+'</span>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="body" style="height:'+i.height+'px;"></div>',0<this.param.btn.length&&(i.html+='<div class="btnbar">',_.each(this.param.btn,function(t){var n=-1==["cancel","refresh"].indexOf(t.action)?' data-loading="执行中..."':"";i.html+="<button\n\t\t\t\t\t\t\t\t"+(_.has(t,"highlight")?' class="highlight"':"")+"\n\t\t\t\t\t\t\t\t"+n+("submit"==t.action?" data-submit":"")+">\n\t\t\t\t\t\t\t"+t.name+"\n\t\t\t\t\t\t\t</button>"}),i.html+="</div>"),i.html+="</div>",body.append(i.html),this.windowDom=$("#"+this.window)}},{key:"_event",value:function(){var a=this,r={},l={close:function(){var t=!(0<arguments.length&&void 0!==arguments[0])||arguments[0],n=a.windowDom.data("change");n=null!=n,a.windowDom.remove(),Mount.window=null,$("."+a.window).remove(),Eadmin.maskHide(),t&&_.isFunction(a.param.close)&&a.param.close(n)},load:function(){if("iframe"!=a.param.model){r.loading.show();var t=100;"popup"==a.param.style&&(t=200),setTimeout(function(){null!=r.scroll&&(r.scroll.destroy(),r.scroll=null),Mount.window=a.window;var t=query(a.param.url);r.body.before('<input type="hidden" id="'+Mount.window+"_query\" value='"+t+"'>").load(a.param.url,function(){defaultImg(r.body),r.loading.hide(),block(r.body),Eadmin.form(r.body),Button.run(a.windowDom),-1!=module.lib.indexOf("tag")&&Tag.run(r.body),r.scroll=Eadmin.scroll("#"+a.window+" .body");var t=body.find(".iscroll");0<t.length&&t.each(function(){if($(this).hasClass("ps"))return!0;Eadmin.scroll($(this)[0])}),-1!=module.lib.indexOf("progress")&&Progress.run(r.body)})},t)}else{var n='<iframe \n\t\t\t\t\t\t\t\t\tsrc="'+a.param.url+'" \n\t\t\t\t\t\t\t\t\twidth="100%" \n\t\t\t\t\t\t\t\t\theight="100%" \n\t\t\t\t\t\t\t\t\tframeborder="0" scrolling="auto">\n\t\t\t\t\t\t\t\t</iframe>';r.body.html(n)}},init:function(t){if(a._create(),r={this:t,title:a.windowDom.children(".title"),body:a.windowDom.children(".body"),loading:a.windowDom.children(".window-loading"),scroll:null},0!=t&&(a.param.url=r.this.data("window-url")),Eadmin.currentHref=a.param.url,null!=a.param.url&&""!=a.param.url){var n=Eadmin.mask();0!=n&&a.windowDom.css("z-index",n),a.windowDom.off("animationend").show().addClass("window"==a.param.style?"zoomIn":"fadeInRight"),l.load(),a.windowDom.children(".window-close").on("click",function(){l.close()}),a.param.drag&&r.title.on("mousedown",function(t){selectEnabled&&userselect(0);var n=a.windowDom.offset();a.x=t.clientX,a.y=t.clientY,a.top=n.top,a.left=n.left;var o=a.windowDom.css("margin-left"),e=a.windowDom.css("margin-top");o=parseInt(o),e=parseInt(e),$(document).on("mousemove",function(t){var n=a.top+(t.clientY-a.y),i=a.left+(t.clientX-a.x);n-=e,i-=o,a.windowDom.css({top:n,left:i})})}).on("mouseup",function(){selectEnabled&&userselect(1),$(document).off("mousemove")}),0!=a.param.btn.length&&a.windowDom.children(".btnbar").children("button").on("click",function(){var t=[$(this),{}],n=t[0],i=t[1];if(i.index=n.index(),i.param=a.param.btn[i.index],_.isString(i.param.action)){if(i.action=["cancel","refresh","submit"],-1==i.action.indexOf(i.param.action))return void console.log("没有找到内置按钮事件："+i.param.action);switch(i.param.action){case"cancel":l.close();break;case"refresh":r.body.empty(),l.load();break;case"submit":var o=function(){r.form=r.body.find(i.param.formid||"form"),0!=r.form.length?(r.action=r.form.attr("action")||a.param.url,Validate.submit(r.form),0<r.form.find("span.error").length||(Eadmin.button.loading(n),r.formData=r.form.serialize(),Eadmin.post({url:r.action,form:r.formData,then:function(){var t=r.form.find(".editor");0<t.length&&t.each(function(){var t=$(this).data("store");null!=t&&store.remove(t)}),_.isFunction(a.param.close)&&a.param.close(!0)},error:function(){Eadmin.button.reset(n)},close:function(){l.close(!1)}}))):console.log("窗体内没有找到form表单元素，提交表单失败")};if(null!=i.param.before)return null==Method||null==Method[i.param.before]?(console.log("弹窗页面中没有找到指定的前置方法"+i.param.before),!1):void Method[i.param.before](o);o()}}else{var e=function(){setTimeout(function(){Eadmin.button.reset(n)},100)};i.param.action({window:a.windowDom,close:function(){l.close()},refresh:function(){e(),r.body.empty(),l.load()},reset:function(){e()}})}})}else console.log("没有指定弹窗地址，打开失败")}};0!=a.dom?a.dom.on("click",function(){l.init($(this))}):l.init(!1)}}]),o}();