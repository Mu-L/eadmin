/*!
 eadmin极速后台UI框架（我只想要个后台） | @author:317953536@qq.com 
*/
"use strict";var _createClass=function(){function i(t,e){for(var a=0;a<e.length;a++){var i=e[a];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(t,e,a){return e&&i(t.prototype,e),a&&i(t,a),t}}();function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var Page=function(){function a(t){var e;_classCallCheck(this,a),this.window=null!=Mount.window?"#"+Mount.window:null,this.param=t,this.get={},this.query="",(this.searchBoxCache=null)!=t.search&&(this.searchBox=null!=this.window?this.window+" "+t.search.boxid:t.search.boxid,this.searchBoxCache=$(this.searchBox)),(this.pageBoxCache=null)!=t.config.page&&(this.pageBox=null!=this.window?this.window+" "+t.config.page.boxid:t.config.page.boxid,this.pageBoxCache=$(this.pageBox),this.storeKey=md5(Eadmin.currentHref),this.page=1,null!=(e=store(this.storeKey+"_page"))&&(this.page=+e),this.pageCount=null,this.size=t.config.page.size,null!=(t=store(this.storeKey+"_size"))&&(this.size=+t),this.get[this.param.config.page.page_field]=this.page,this.get[this.param.config.page.size_field]=this.size),this.tmpBox=scope('[data-template="'+this.param.config.tmp+'"]'),this.init=!1,this.run()}return _createClass(a,[{key:"run",value:function(){this._create(),this._event()}},{key:"_create",value:function(){var t=this,i=this;(function(){var a;null!=t.param.search&&(a='<div class="table-search"><form><div class="block-box">',_.each(t.param.search.field,function(t,e){switch(a+='<div class="col-3"><div class="form-group">',t.type){case"input":a+='<div class="input-group">\n\t\t\t\t\t\t\t\t\t\t<span class="prepend">'+t.name+'</span>\n\t\t\t\t\t\t\t\t\t\t<input name="'+e+'" type="text" placeholder="请输入'+t.name+'">\n\t\t\t\t\t\t\t\t\t</div>';break;case"datepicker":a+='<div class="input-group">\n\t\t\t\t\t\t\t\t\t\t<span class="prepend">'+t.name+'</span>\n\t\t\t\t\t\t\t\t\t\t<input \n\t\t\t\t\t\t\t\t\t\t\tid="table-datepicker-'+e+'" \n\t\t\t\t\t\t\t\t\t\t\tclass="table-datepicker"\n\t\t\t\t\t\t\t\t\t\t\tname="'+e+'" \n\t\t\t\t\t\t\t\t\t\t\ttype="text" \n\t\t\t\t\t\t\t\t\t\t\tplaceholder="请选择'+t.name+'">\n\t\t\t\t\t\t\t\t\t</div>';break;case"citypicker":a+='<div class="input-group">\n\t\t\t\t\t\t\t\t\t\t<span class="prepend">'+t.name+'</span>\n\t\t\t\t\t\t\t\t\t\t<input \n\t\t\t\t\t\t\t\t\t\t\tid="table-citypicker-'+e+'" \n\t\t\t\t\t\t\t\t\t\t\tclass="table-citypicker"\n\t\t\t\t\t\t\t\t\t\t\tname="'+e+'" \n\t\t\t\t\t\t\t\t\t\t\ttype="text" \n\t\t\t\t\t\t\t\t\t\t\tplaceholder="请选择'+t.name+'">\n\t\t\t\t\t\t\t\t\t</div>';break;case"select":a+='<select name="'+e+'" data-width="100%" data-custom-txt="'+t.name+'">\n\t\t\t\t\t\t\t\t\t\t<option value="">请选择'+t.name+"</option>",_.each(t.option,function(t){a+='<option value="'+t.val+'">'+t.key+"</option>"}),a+="</select>"}a+="</div></div>"}),t.searchBoxCache.prepend(a+='<div class="col-3">\n\t\t\t\t\t\t\t<button class="search-do middle highlight">\n\t\t\t\t\t\t\t\t<i class="ri-search-line"></i>搜索\n\t\t\t\t\t\t\t</button><button class="search-refresh middle">\n\t\t\t\t\t\t\t\t<i class="ri-refresh-line"></i>重置\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div></form></div>'),t.searchBoxCache.find(".table-datepicker").each(function(){var t=$(this),e=t.attr("name"),a={};null!=i.param.search.field[e].param&&(a=i.param.search.field[e].param),Eadmin.datepicker("#"+t.attr("id"),a)}),t.searchBoxCache.find(".table-citypicker").each(function(){var t=$(this),e=t.attr("name"),a={};null!=i.param.search.field[e].param&&(a=i.param.search.field[e].param),Eadmin.citypicker("#"+t.attr("id"),a)}))})(),this._loadData(!1)}},{key:"_event",value:function(){var t=[".search-do",".search-refresh",".table-page select",".table-page .num-page:not(.current)",".table-page .prev-page",".table-page .next-page",".table-page button"],e=this,a=function(t){Eadmin.message.error({content:t}),e.pageBox.find("input").val("")};null!=e.param.search&&e.searchBoxCache.on("click",t[0],function(){e.page=1,e.get[e.param.config.page.page_field]=e.page;var t=e.searchBoxCache.find("form").serialize();t!=e.query&&(e.get._search=1,e.query=t);t=_.split(t,"&");return _.each(t,function(t){t=_.split(t,"=");e.get[t[0]]=decodeURIComponent(t[1])}),e._loadData(!0),!1}).on("click",t[1],function(){return e.searchBoxCache.find("input").val(""),Form.select(e.searchBoxCache),!1}),null!=e.param.config.page&&e.pageBoxCache.on("change",t[2],function(){e.page=1,e.size=+$(this).val(),store(e.storeKey+"_page",e.page.toString()),store(e.storeKey+"_size",e.size.toString()),e.get[e.param.config.page.page_field]=e.page,e.get[e.param.config.page.size_field]=e.size,e._loadData(!0)}).on("click",t[3],function(){e.page=+$(this).html(),store(e.storeKey+"_page",e.page.toString()),e.get[e.param.config.page.page_field]=e.page,e._loadData(!0)}).on("click",t[4],function(){1!=e.page&&(--e.page,store(e.storeKey+"_page",e.page.toString()),e.get[e.param.config.page.page_field]=e.page,e._loadData(!0))}).on("click",t[5],function(){e.page!=e.pageCount&&(e.page+=1,store(e.storeKey+"_page",e.page.toString()),e.get[e.param.config.page.page_field]=e.page,e._loadData(!0))}).on("click",t[6],function(){var t=e.pageBoxCache.find("input").val();""!=t?t<1?a("跳转的页数不能小于1"):t>e.pageCount?a("跳转的页数已经超出了最大页数"):t!=e.page?(store(e.storeKey+"_page",t),e.page=+t,e.get[e.param.config.page.page_field]=e.page,e._loadData(!0)):a("已经在待跳转的页面了"):a("跳转的页数不能为空")})}},{key:"_page",value:function(t){var e=1<arguments.length&&void 0!==arguments[1]&&arguments[1];if(this.param.config.page)if(_.has(t,"count")){this.init||this.pageBoxCache.data("size",this.size);var a={count:this.pageBoxCache.find("em:first"),page:this.pageBoxCache.find("em").eq(1),pageCount:this.pageBoxCache.find("em").eq(2)};t.count==+a.count.html()&&this.size==this.pageBoxCache.data("size")||(t.count<this.size?this.pageCount=1:t.count%this.size==0?this.pageCount=t.count/this.size:this.pageCount=parseInt(t.count/this.size)+1,a.count.html(t.count),a.pageCount.html(this.pageCount),this.size!=this.pageBoxCache.data("size")&&this.pageBoxCache.data("size",this.size)),a.page.html(this.page);t=10;_.has(this.param.config.page,"num")&&10<(t=(t=this.param.config.page.num)<3?3:t)&&(t=10);var i="",a=this.page,n=t+((a-=_.floor(t/2))<1?(a=1,0):this.page-_.floor(t/2)-1);(n=n>this.pageCount?this.pageCount:n)-a<t-1&&(a-=t-(n-a)-1);for(var s=a=a<1?1:a;s<=n;s++)i+='<span class="num-page'+(s==this.page?" current":"")+'" data-page="'+s+'">'+s+"</span>";this.pageBoxCache.find(".num-page").remove(),this.pageBoxCache.find(".prev-page").after(i),this.init&&e&&module.conf.page_show_message&&Eadmin.message.success({content:"当前第 "+this.page+" 页，共 "+this.pageCount+" 页"})}else console.log("数据源中未包含数据总条数count字段，创建分页失败")}},{key:"_loadData",value:function(){var a=this,i=0<arguments.length&&void 0!==arguments[0]&&arguments[0];this.tmpBox.html('<div class="table-shade" style="display:flex;">\n\t\t\t\t\t\t<i class="ri-loader-4-line rotate"></i>数据加载中，请稍候...\n\t\t\t\t\t</div>'),this.searchBoxCache.hide(),this.pageBoxCache.hide(),i&&(null!=this.window?_.startsWith(this.window,"#tab")||($(this.window+" .body")[0].scrollTop=0):box[0].scrollTop=0),Eadmin.get({url:this.param.config.data,param:this.get,then:function(t){var e;null!=t.count||null==a.param.config.page?null!=t.list?(Eadmin.template(a.param.config.tmp,t,function(){col(a.tmpBox),defaultImg(a.tmpBox),_.isFunction(a.param.callback)&&a.param.callback(t)}),a.searchBoxCache.show(),a.pageBoxCache.show(),0<t.count?(a.param.config.page&&(e='<div class="table-page">\n\t\t\t\t\t\t\t<span class="info">\n\t\t\t\t\t\t\t\t共<em></em>条，每页\n\t\t\t\t\t\t\t\t<select name="pagesize" data-width="70">\n\t\t\t\t\t\t\t\t\t<option value="0">请选择</option>\n\t\t\t\t\t\t\t\t\t<option value="'+(e=a.param.config.page.size)+'"'+(a.size==e?" selected":"")+">"+e+'</option>\n\t\t\t\t\t\t\t\t\t<option value="'+2*e+'"'+(a.size==2*e?" selected":"")+">"+2*e+'</option>\n\t\t\t\t\t\t\t\t\t<option value="'+3*e+'"'+(a.size==3*e?" selected":"")+">"+3*e+'</option>\n\t\t\t\t\t\t\t\t\t<option value="'+4*e+'"'+(a.size==4*e?" selected":"")+">"+4*e+"</option>\n\t\t\t\t\t\t\t\t</select>\n\t\t\t\t\t\t\t\t条，\n\t\t\t\t\t\t\t\t当前 <em>"+a.page+'</em>/<em>-</em> 页\n\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t<span class="prev-page"><i class="ri-arrow-left-s-line"></i></span>\n\t\t\t\t\t\t\t<span class="next-page"><i class="ri-arrow-right-s-line"></i></span>\n\t\t\t\t\t\t\t<span class="jump">\n\t\t\t\t\t\t\t\t跳转到第\n\t\t\t\t\t\t\t\t<input name="page" type="text" placeholder="页数">\n\t\t\t\t\t\t\t\t页\n\t\t\t\t\t\t\t\t<button class="highlight small">确定</button>\n\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t</div>',a.pageBoxCache.html(e),Eadmin.form(a.pageBoxCache)),a._page(t,i)):a.searchBoxCache.append('<div class="empty">该列表暂无更多数据~</div>'),a.init=!0,a.get._search=0):console.log("数据源中没有包含list字段"):console.log("返回的数据源中没有 count 字段，无法使用分页")}})}}]),a}();