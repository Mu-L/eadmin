/*!
 eadmin极速后台UI框架（我只想要个后台） | @author:317953536@qq.com 
*/
"use strict";var _createClass=function(){function i(t,e){for(var a=0;a<e.length;a++){var i=e[a];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(t,e,a){return e&&i(t.prototype,e),a&&i(t,a),t}}();function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var Page=function(){function i(t){if(_classCallCheck(this,i),Mount.page=!0,this.window=null!=Mount.window?"#"+Mount.window:null,this.param=t,this.get={},this.query="",null!=t.search&&(this.searchBox=null!=this.window?this.window+" "+t.search.boxid:t.search.boxid,this.searchBoxCache=$(this.searchBox)),null!=t.config.page){this.pageBox=null!=this.window?this.window+" "+t.config.page.boxid:t.config.page.boxid,this.pageBoxCache=$(this.pageBox),this.storeKey=md5(Eadmin.currentHref),this.page=1;var e=store(this.storeKey+"_page");null!=e&&(this.page=+e),this.pageCount=null,this.size=t.config.page.size;var a=store(this.storeKey+"_size");null!=a&&(this.size=+a),this.get[this.param.config.page.page_field]=this.page,this.get[this.param.config.page.size_field]=this.size}this.tmpBox=scope('[data-template="'+this.param.config.tmp+'"]'),this.init=!1,this.run()}return _createClass(i,[{key:"run",value:function(){this._create(),this._event()}},{key:"_create",value:function(){var t=this,i=this;(function(){if(null!=t.param.search){var a='<div class="table-search"><form><div class="block-box">';_.each(t.param.search.field,function(t,e){switch(a+='<div class="col-3"><div class="form-group">',t.type){case"input":a+='<div class="input-group">\n\t\t\t\t\t\t\t\t\t\t<span class="prepend">'+t.name+'</span>\n\t\t\t\t\t\t\t\t\t\t<input name="'+e+'" type="text" placeholder="请输入'+t.name+'">\n\t\t\t\t\t\t\t\t\t</div>';break;case"datepicker":a+='<div class="input-group">\n\t\t\t\t\t\t\t\t\t\t<span class="prepend">'+t.name+'</span>\n\t\t\t\t\t\t\t\t\t\t<input \n\t\t\t\t\t\t\t\t\t\t\tid="table-datepicker-'+e+'" \n\t\t\t\t\t\t\t\t\t\t\tclass="table-datepicker"\n\t\t\t\t\t\t\t\t\t\t\tname="'+e+'" \n\t\t\t\t\t\t\t\t\t\t\ttype="text" \n\t\t\t\t\t\t\t\t\t\t\tplaceholder="请选择'+t.name+'">\n\t\t\t\t\t\t\t\t\t</div>';break;case"citypicker":a+='<div class="input-group">\n\t\t\t\t\t\t\t\t\t\t<span class="prepend">'+t.name+'</span>\n\t\t\t\t\t\t\t\t\t\t<input \n\t\t\t\t\t\t\t\t\t\t\tid="table-citypicker-'+e+'" \n\t\t\t\t\t\t\t\t\t\t\tclass="table-citypicker"\n\t\t\t\t\t\t\t\t\t\t\tname="'+e+'" \n\t\t\t\t\t\t\t\t\t\t\ttype="text" \n\t\t\t\t\t\t\t\t\t\t\tplaceholder="请选择'+t.name+'">\n\t\t\t\t\t\t\t\t\t</div>';break;case"select":a+='<select name="'+e+'" data-width="100%" data-custom-txt="'+t.name+'">\n\t\t\t\t\t\t\t\t\t\t<option value="">请选择'+t.name+"</option>",_.each(t.option,function(t){a+='<option value="'+t.val+'">'+t.key+"</option>"}),a+="</select>"}a+="</div></div>"}),a+='<div class="col-3">\n\t\t\t\t\t\t\t<button class="search-do middle highlight">\n\t\t\t\t\t\t\t\t<i class="ri-search-line"></i>搜索\n\t\t\t\t\t\t\t</button><button class="search-refresh middle">\n\t\t\t\t\t\t\t\t<i class="ri-refresh-line"></i>重置\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div></form></div>',t.searchBoxCache.prepend(a),t.searchBoxCache.find(".table-datepicker").each(function(){var t=$(this),e=t.attr("name"),a={};null!=i.param.search.field[e].param&&(a=i.param.search.field[e].param),Eadmin.datepicker("#"+t.attr("id"),a)}),t.searchBoxCache.find(".table-citypicker").each(function(){var t=$(this),e=t.attr("name"),a={};null!=i.param.search.field[e].param&&(a=i.param.search.field[e].param),Eadmin.citypicker("#"+t.attr("id"),a)})}})(),this._loadData(!1)}},{key:"_event",value:function(){var t=[".search-do",".search-refresh",".table-page select",".table-page .num-page:not(.current)",".table-page .prev-page",".table-page .next-page",".table-page button"],a=this,e=function(t){Eadmin.message.error({content:t}),a.pageBox.find("input").val("")};null!=a.param.search&&a.searchBoxCache.on("click",t[0],function(){a.page=1,a.get[a.param.config.page.page_field]=a.page;var t=a.searchBoxCache.find("form").serialize();t!=a.query&&(a.get._search=1,a.query=t);var e=_.split(t,"&");return _.each(e,function(t){var e=_.split(t,"=");a.get[e[0]]=decodeURIComponent(e[1])}),a._loadData(!0),!1}).on("click",t[1],function(){return a.searchBoxCache.find("input").val(""),Form.select(a.searchBoxCache),!1}),null!=a.param.config.page&&a.pageBoxCache.on("change",t[2],function(){a.page=1,a.size=+$(this).val(),store(a.storeKey+"_page",a.page.toString()),store(a.storeKey+"_size",a.size.toString()),a.get[a.param.config.page.page_field]=a.page,a.get[a.param.config.page.size_field]=a.size,a._loadData(!0)}).on("click",t[3],function(){a.page=+$(this).html(),store(a.storeKey+"_page",a.page.toString()),a.get[a.param.config.page.page_field]=a.page,a._loadData(!0)}).on("click",t[4],function(){1!=a.page&&(a.page-=1,store(a.storeKey+"_page",a.page.toString()),a.get[a.param.config.page.page_field]=a.page,a._loadData(!0))}).on("click",t[5],function(){a.page!=a.pageCount&&(a.page+=1,store(a.storeKey+"_page",a.page.toString()),a.get[a.param.config.page.page_field]=a.page,a._loadData(!0))}).on("click",t[6],function(){var t=a.pageBoxCache.find("input").val();""!=t?t<1?e("跳转的页数不能小于1"):t>a.pageCount?e("跳转的页数已经超出了最大页数"):t!=a.page?(store(a.storeKey+"_page",t),a.page=+t,a.get[a.param.config.page.page_field]=a.page,a._loadData(!0)):e("已经在待跳转的页面了"):e("跳转的页数不能为空")})}},{key:"_page",value:function(t){var e=1<arguments.length&&void 0!==arguments[1]&&arguments[1];if(this.param.config.page)if(_.has(t,"count")){this.init||this.pageBoxCache.data("size",this.size);var a={count:this.pageBoxCache.find("em:first"),page:this.pageBoxCache.find("em").eq(1),pageCount:this.pageBoxCache.find("em").eq(2)};t.count==+a.count.html()&&this.size==this.pageBoxCache.data("size")||(t.count<this.size?this.pageCount=1:t.count%this.size==0?this.pageCount=t.count/this.size:this.pageCount=parseInt(t.count/this.size)+1,a.count.html(t.count),a.pageCount.html(this.pageCount),this.size!=this.pageBoxCache.data("size")&&this.pageBoxCache.data("size",this.size)),a.page.html(this.page);var i=10;_.has(this.param.config.page,"num")&&((i=this.param.config.page.num)<3&&(i=3),10<i&&(i=10));var n="",s=this.page,o=i+((s-=_.floor(i/2))<1?(s=1,0):this.page-_.floor(i/2)-1);o>this.pageCount&&(o=this.pageCount),o-s<i-1&&(s-=i-(o-s)-1),s<1&&(s=1);for(var p=s;p<=o;p++)n+='<span class="num-page'+(p==this.page?" current":"")+'" data-page="'+p+'">'+p+"</span>";this.pageBoxCache.find(".num-page").remove(),this.pageBoxCache.find(".prev-page").after(n),this.init&&e&&this.param.config.page.show_message&&Eadmin.message.success({content:"当前第 "+this.page+" 页，共 "+this.pageCount+" 页"})}else console.log("数据源中未包含数据总条数count字段，创建分页失败")}},{key:"_loadData",value:function(){var a=this,e=0<arguments.length&&void 0!==arguments[0]&&arguments[0];Eadmin.loading("数据加载中，请稍候..."),e&&(this.tmpBox.empty(),null!=this.window?_.startsWith(this.window,"#tab")||($(this.window+" .body")[0].scrollTop=0):box[0].scrollTop=0),Eadmin.get({url:this.param.config.data,param:this.get,then:function(t){null!=t.count||null==a.param.config.page?null!=t.list?(Eadmin.template(a.param.config.tmp,t,function(){col(a.tmpBox),defaultImg(a.tmpBox),_.isFunction(a.param.callback)&&a.param.callback(t)}),0<t.count?(!function(){if(a.param.config.page){var t=a.param.config.page.size,e='<div class="table-page">\n\t\t\t\t\t\t\t<span class="info">\n\t\t\t\t\t\t\t\t共<em></em>条，每页\n\t\t\t\t\t\t\t\t<select name="pagesize" data-width="70">\n\t\t\t\t\t\t\t\t\t<option value="0">请选择</option>\n\t\t\t\t\t\t\t\t\t<option value="'+t+'"'+(a.size==t?" selected":"")+">"+t+'</option>\n\t\t\t\t\t\t\t\t\t<option value="'+2*t+'"'+(a.size==2*t?" selected":"")+">"+2*t+'</option>\n\t\t\t\t\t\t\t\t\t<option value="'+3*t+'"'+(a.size==3*t?" selected":"")+">"+3*t+'</option>\n\t\t\t\t\t\t\t\t\t<option value="'+4*t+'"'+(a.size==4*t?" selected":"")+">"+4*t+"</option>\n\t\t\t\t\t\t\t\t</select>\n\t\t\t\t\t\t\t\t条，\n\t\t\t\t\t\t\t\t当前 <em>"+a.page+'</em>/<em>-</em> 页\n\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t<span class="prev-page"><i class="ri-arrow-left-s-line"></i></span>\n\t\t\t\t\t\t\t<span class="next-page"><i class="ri-arrow-right-s-line"></i></span>\n\t\t\t\t\t\t\t<span class="jump">\n\t\t\t\t\t\t\t\t跳转到第\n\t\t\t\t\t\t\t\t<input name="page" type="text" placeholder="页数">\n\t\t\t\t\t\t\t\t页\n\t\t\t\t\t\t\t\t<button class="highlight small">确定</button>\n\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t</div>';a.pageBoxCache.html(e),Eadmin.form(a.pageBoxCache)}}(),a._page(t,e)):a.searchBoxCache.append('<div class="empty">该列表暂无更多数据~</div>'),Mount.page=!1,Eadmin.loadingHide(),a.init=!0,a.get._search=0):console.log("数据源中没有包含list字段"):console.log("返回的数据源中没有 count 字段，无法使用分页")}})}}]),i}();