/*!
 eadmin极速后台UI框架（我只想要个后台） | @author:317953536@qq.com 
*/
"use strict";var _createClass=function(){function i(e,t){for(var a=0;a<t.length;a++){var i=t[a];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(e,t,a){return t&&i(e.prototype,t),a&&i(e,a),e}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var Editor=function(){function n(e,t){if(_classCallCheck(this,n),this.storeKey=md5(Eadmin.currentHref+e),this.dom=e,this.domCache=scope(this.dom),this.dom+=(new Date).valueOf(),null==this.domCache.data("name"))return console.log("请为富文本编辑框指定data-name属性，用来后端取值"),!1;var a=this.domCache.html();this.domCache.attr("id",this.dom.replace("#","")).data("store",this.storeKey).addClass("editor").after('<input type="hidden" name="'+this.domCache.data("name")+'">');if(this.param=$.extend(!0,{name:"editor",height:300,readonly:!1,placeholder:"请输入内容...",doc:[".jpg",".png",".jpeg",".gif"],size:1e3,api:"upload.php",filename:"file",autosave:!1,savetime:3},t),""!=this.param.api){if(!_.startsWith(this.param.api,"http")){if(!_.startsWith(module.conf.http.baseURL,"http"))return console.log("上传文件接收接口地址不完整"),!1;this.param.api=module.conf.http.baseURL+this.param.api}if(this.domCache.css("min-height",this.param.height).after('<input class="dn" type="file" accept="image/*">'),""==a){var i=store(this.storeKey);null!=i&&this.domCache.html(i)}this.quill=null,this.create()}else console.log("请指定后端接收上传数据的API地址")}return _createClass(n,[{key:"create",value:function(){var e=this;this.quill=new Quill(this.dom,{theme:"snow",modules:{toolbar:[["bold","italic","underline","strike",{header:[1,2,3,4,5,6,!1]}],[{size:["small",!1,"large","huge"]}],[{color:[]},{background:[]}],["blockquote","code-block"],[{list:"ordered"},{list:"bullet"}],[{indent:"-1"},{indent:"+1"}],[{align:[]}],[{direction:"rtl"}],["clean","link","image","video"]]},placeholder:this.param.placeholder,readOnly:this.param.readonly}),this.domCache.next().next("input[type='hidden']").val(this.quill.root.innerHTML);var t=this.domCache.next("input[type='file']");this.quill.getModule("toolbar").addHandler("image",function(){t.val("").trigger("click")});var n=this;t.on("change",function(e){var t=e.target.files[0],a=t.type.replace(/image\//,".");if(-1!=n.param.doc.indexOf(a))if(n.param.size*=1e3,t.size>n.param.size)Eadmin.message.error({content:"图片大小超出限制，上传失败"});else{var i=new FormData;i.append(n.param.filename,t,t.name),module.conf.http.headers["Content-Type"]="multipart/form-data",Eadmin.post({url:n.param.api,form:i,then:function(e){var t=n.quill.getSelection(),a=0+(null!==t?t.index:0);n.quill.insertEmbed(a,"image",e.pic),n.quill.setSelection(1+a)}})}else Eadmin.message.error({content:"图片格式不允许，上传失败"})}),this.param.autosave&&(this.quill.on("text-change",_.debounce(function(){store(e.storeKey,e.quill.root.innerHTML),Eadmin.message.info({content:"编辑内容已实时保存至本地"})},1e3*this.param.savetime)),this.quill.on("text-change",function(){e.domCache.next().next("input[type='hidden']").val(e.quill.root.innerHTML)}))}}]),n}();